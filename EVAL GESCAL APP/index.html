<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quality Supervision Interface v3.0 (Definitiva)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0a0f18; --primary-color: #00e5ff; --text-color: #e0e0e0;
            --border-color: rgba(0, 229, 255, 0.3); --container-bg: rgba(20, 30, 45, 0.85);
            --glow-shadow: 0 0 5px var(--primary-color), 0 0 10px var(--primary-color), 0 0 15px var(--primary-color);
            --red-glow: #ff4757; --yellow-glow: #feca57; --green-glow: #2ecc71;
            --danger-color: #ff4757; --new-eval-color: #feca57;
        }
        body {
            font-family: 'Exo 2', sans-serif; margin: 0; padding: 25px; background-color: var(--bg-color);
            background-image: linear-gradient(rgba(0, 229, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 229, 255, 0.05) 1px, transparent 1px);
            background-size: 30px 30px; color: var(--text-color); font-weight: 300;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; }
        .container {
            max-width: 950px; margin: auto; background: var(--container-bg); padding: 30px;
            border-radius: 10px; border: 1px solid var(--border-color);
            box-shadow: 0 0 25px rgba(0, 229, 255, 0.2); backdrop-filter: blur(10px);
        }
        h1 {
            text-align: center; color: #fff; font-weight: 600; font-size: 2.5em;
            text-shadow: var(--glow-shadow); margin-bottom: 30px; letter-spacing: 2px;
            line-height: 1.2;
        }
        h1 .subtitle {
            display: block; font-size: 0.6em; font-weight: 600; 
            letter-spacing: 1px; margin-top: 5px;
        }
        h3 {
            color: var(--primary-color); font-weight: 400; border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px; margin-bottom: 20px; letter-spacing: 1px;
        }
        .form-section {
            margin-bottom: 30px; padding: 20px; border: 1px solid var(--border-color);
            border-radius: 5px; background-color: rgba(0,0,0,0.1);
        }
        .form-group { margin-bottom: 15px; }
        .form-group input[type="text"], .form-group input[type="date"] {
            width: 100%; padding: 12px; box-sizing: border-box; background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-color);
            font-family: 'Exo 2', sans-serif; font-size: 1em; transition: all 0.3s ease;
        }
        .form-group input:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.5);
        }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 400; color: var(--primary-color); }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: left; vertical-align: middle; }
        th { background-color: rgba(0, 229, 255, 0.1); color: var(--primary-color); font-weight: 600; }
        tbody tr:hover { background-color: rgba(0, 229, 255, 0.08); }
        .radio-container { display: flex; justify-content: center; align-items: center; gap: 15px; }
        .radio-container input[type="radio"] { display: none; }
        .radio-container label {
            cursor: pointer; padding: 5px 15px; border: 1px solid var(--border-color);
            border-radius: 20px; transition: all 0.3s ease; font-weight: 600; user-select: none;
        }
        .radio-container input[value="si"] + label { color: var(--green-glow); border-color: #2ecc714d; }
        .radio-container input[value="si"]:checked + label {
            background-color: var(--green-glow); color: #fff; border-color: var(--green-glow);
            box-shadow: 0 0 10px var(--green-glow);
        }
        .radio-container input[value="no"] + label { color: var(--red-glow); border-color: #ff47574d; }
        .radio-container input[value="no"]:checked + label {
            background-color: var(--red-glow); color: #fff; border-color: var(--red-glow);
            box-shadow: 0 0 10px var(--red-glow);
        }
        textarea {
            width: 100%; height: 40px; padding: 8px; box-sizing: border-box; background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-color);
            font-family: 'Exo 2', sans-serif; resize: vertical; transition: all 0.3s ease;
        }
        textarea:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.5);
        }
        .summary-section {
            margin-top: 40px; padding: 25px; border: 1px solid var(--border-color);
            border-radius: 5px; background: rgba(0, 229, 255, 0.05);
        }
        .summary-table { font-size: 1.2em; }
        .summary-table td { text-align: center; font-weight: 600;}
        #totalSi { color: #fff; }
        #porcentajeSi { font-size: 1.5em; transition: color 0.5s ease; }
        .progress-bar-container {
            width: 100%; height: 25px; background-color: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color); border-radius: 15px;
            margin-top: 15px; overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%; width: 0%; border-radius: 15px;
            transition: width 0.5s ease-in-out, background-color 0.5s ease, box-shadow 0.5s ease;
            text-align: center; line-height: 25px; color: #0a0f18;
            font-weight: 600; font-size: 0.9em;
        }
        .actions-section { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; margin-top: 40px; }
        .action-button {
            padding: 12px 25px; background-color: transparent; color: var(--primary-color);
            border: 2px solid var(--primary-color); border-radius: 5px; cursor: pointer;
            font-family: 'Exo 2', sans-serif; font-size: 1em; font-weight: 600;
            transition: all 0.3s ease;
        }
        .action-button:hover {
            background-color: var(--primary-color); color: var(--bg-color);
            box-shadow: var(--glow-shadow);
        }
        #newEvaluationBtn {
            border-color: var(--new-eval-color);
            color: var(--new-eval-color);
        }
        #newEvaluationBtn:hover {
            background-color: var(--new-eval-color);
            color: var(--bg-color);
            box-shadow: 0 0 10px var(--new-eval-color);
        }
        #saved-evaluations-section { display: none; margin-top: 30px; }
        .saved-item {
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            padding: 15px; border: 1px solid var(--border-color);
            border-radius: 5px; margin-bottom: 10px; background: rgba(0,0,0,0.1); gap: 10px;
        }
        .saved-item-info { font-size: 1.1em; flex-grow: 1; }
        .saved-item-actions button { margin-left: 10px; }
        .small-button { padding: 5px 10px; font-size: 0.9em; } /* MEJORA: Para botones en la lista */

        .delete-btn {
            background-color: transparent; border: 1px solid var(--danger-color);
            color: var(--danger-color); border-radius: 4px;
            cursor: pointer; transition: all 0.3s ease;
        }
        .delete-btn:hover { background-color: var(--danger-color); color: #fff; }
        .signatures { margin-top: 50px; display: flex; justify-content: space-around; gap: 30px; }
        .signature-box {
            text-align: center; width: 45%; padding-top: 20px;
            border-top: 1px dashed var(--border-color); font-weight: 300;
            color: var(--primary-color); letter-spacing: 1px;
        }
        @media print {
            body { background: none; color: #000; padding: 0; }
            .container { box-shadow: none; border: none; padding: 0; backdrop-filter: none; background: none; max-width: 100%; }
            .actions-section, .progress-bar-container, #saved-evaluations-section { display: none; }
            h1, h3 { color: #000; text-shadow: none; }
            table, th, td { border: 1px solid #ccc; color: #000; }
            .form-section, .summary-section { border: 1px solid #ccc; background: none; padding: 10px; page-break-inside: avoid; }
            .signature-box { color: #000; border-top: 1px solid #000; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>
        SUPERVISION DE CALIDAD RED DE SALUD YACUIBA
        <span class="subtitle">Fund. EEGO</span>
    </h1>

    <div id="saved-evaluations-section" class="form-section">
        <h3>EVALUACIONES GUARDADAS</h3>
        <div id="saved-list"></div>
        <!-- MEJORA: Botón para volver atrás/cerrar la sección de guardados -->
        <div style="text-align: center; margin-top: 20px;">
            <button id="hideSavedBtn" class="action-button">Ocultar Guardados</button>
        </div>
    </div>

    <div id="mainFormContainer">
        <div class="form-section">
            <h3>DATOS GENERALES</h3>
            <div class="form-group"><label for="nombreEstablecimiento">Nombre del Establecimiento de Salud:</label><input type="text" id="nombreEstablecimiento"></div>
            <div class="form-group"><label for="nombreCoordinador">Nombre del/la Coordinador de Red:</label><input type="text" id="nombreCoordinador"></div>
            <div class="form-group"><label for="jefeResponsable">Jefe o Responsable del Establecimiento de Salud:</label><input type="text" id="jefeResponsable"></div>
            <div class="form-group"><label for="fechaSupervision">Fecha de supervisión:</label><input type="date" id="fechaSupervision"></div>
        </div>
        <div class="form-section">
            <h3>DATOS DE LOS PARTICIPANTES</h3>
            <div class="form-group"><label for="evaluadorNombre">Nombre del Evaluador:</label><input type="text" id="evaluadorNombre"></div>
            <div class="form-group"><label for="evaluadorCargo">Cargo del Evaluador:</label><input type="text" id="evaluadorCargo"></div>
            <div class="form-group"><label for="evaluadoNombre">Nombre del Evaluado:</label><input type="text" id="evaluadoNombre"></div>
            <div class="form-group"><label for="evaluadoCargo">Cargo del Evaluado:</label><input type="text" id="evaluadoCargo"></div>
        </div>
        <form id="checklistForm"></form>
    </div>

    <div class="summary-section">
        <h3>RESULTADO DE SUPERVISIÓN</h3>
        <table class="summary-table">
            <thead><tr><th>TOTAL EVALUADOS</th><th>N° CUMPLIDOS</th><th>% CUMPLIMIENTO</th></tr></thead>
            <tbody><tr><td id="totalItems">0</td><td id="totalSi">0</td><td id="porcentajeSi">0.00%</td></tr></tbody>
        </table>
        <div class="progress-bar-container"><div class="progress-bar-fill" id="progressBar"></div></div>
    </div>
    
    <div class="actions-section">
        <button id="newEvaluationBtn" class="action-button">Limpiar / Nueva Evaluación</button>
        <button id="finishBtn" class="action-button">Guardar Evaluación Actual</button>
        <button id="viewSavedBtn" class="action-button">Ver Evaluaciones Guardadas</button>
        <button id="downloadBtn" class="action-button">Descargar Reporte Actual</button>
        <button id="printBtn" class="action-button">Imprimir</button>
    </div>

    <div class="signatures">
        <div class="signature-box">FIRMA Y SELLO DEL EVALUADOR</div>
        <div class="signature-box">FIRMA Y SELLO DEL EVALUADO</div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    try {
        const form = document.getElementById('checklistForm');
        const downloadBtn = document.getElementById('downloadBtn');
        const printBtn = document.getElementById('printBtn');
        const finishBtn = document.getElementById('finishBtn');
        const viewSavedBtn = document.getElementById('viewSavedBtn');
        const savedEvaluationsSection = document.getElementById('saved-evaluations-section');
        const savedListContainer = document.getElementById('saved-list');
        const totalSiElem = document.getElementById('totalSi');
        const porcentajeSiElem = document.getElementById('porcentajeSi');
        const progressBar = document.getElementById('progressBar');
        const totalItemsElem = document.getElementById('totalItems');
        const newEvaluationBtn = document.getElementById('newEvaluationBtn');
        const hideSavedBtn = document.getElementById('hideSavedBtn'); // MEJORA
        
        const checklistData = {
            "1. Requisitos Básicos": [ { id: "1.1", text: "El Establecimiento está legalmente autorizado, por el Servicio Departamental de Salud (Resolución Administrativa de Habilitación/funcionamiento)." },{ id: "1.2", text: "Señalización externa e interna." },{ id: "1.3", text: " La infraestructura del establecimiento debe estar en buenas condiciones de presentación: paredes pintadas y limpias no descascaradas, ni con revoque deteriorado, sin humedad ni goteras." },{ id: "1.4", text: "Superficies lisas en áreas restringidas." },{ id: "1.5", text: " Ausencia de polvo, basura, animales domésticos y vectores." },{ id: "1.6", text: " Ausencia de escombros, muebles y equipos dados de baja en dependencia y terrenos aledaños al establecimiento." },{ id: "1.7", text: " Disponibilidad de servicios básicos (energía eléctrica, agua potable y medios de comunicación." },{ id: "1.8", text: " Tanques de reserva de agua y motor para restablecer la energía eléctrica de corte de servicios." },{ id: "1.9", text: " Personal con identificación, uniforme pulcro y limpio." },{ id: "1.10", text: " Instalaciones para circulación vertical de camillas y sillas de rueda (rampas  ascensores)." } ],
            "2. Plan Operativo Anual": [ { id: "2.1", text: " Actividades educativas y de capacitación a la comunidad." },{ id: "2.2", text: " Actividades de capacitación continua al R.R.H.H. institucional." },{ id: "2.3", text: "Plan de gestión de equipamiento." },{ id: "2.4", text: "Contemple insumos de Bioseguridad." },{ id: "2.5", text: "Planifique disposición de medicamentos." } ],
            "3. Misión y Visión": [ { id: "3.1", text: "Se tiene definida la Misión." },{ id: "3.2", text: "Se tiene definida la Visión." } ],
            "4. Documentación básica": [ { id: "4.1", text: "Manual de Organización, Funciones y cargos." },{ id: "4.2", text: "Organigrama." },{ id: "4.3", text: "Manual de Inducción." },{ id: "4.4", text: "Manual de Procesos y Procedimientos." },{ id: "4.5", text: "Material educativo." },{ id: "4.6", text: " File completo de todo el personal de acuerdo al manual de cargos." },{ id: "4.7.1", text: "Manual de Gestión de la Calidad." },{ id: "4.7.2", text: "Programa de gestión de calidad." },{ id: "4.8.1", text: "Manual de Bioseguridad." },{ id: "4.8.2", text: "Manual de Gestión de Residuos Sólidos." },{ id: "4.8.3", text: "Programa de inmunizaciones del personal." },{ id: "4.8.4", text: " Registros de control médico y de laboratorio del recurso humano institucional." },{ id: "4.9.1", text: "Reglamentos para manejo de información." },{ id: "4.9.2", text: "Archivos de Documentación administrativa." },{ id: "4.9.3", text: " Informes epidemiológicos y de producción con constancia de recepción." },{ id: "4.9.4", text: "Registro de entrega de información." },{ id: "4.10.1", text: "Plan de contingencias." },{ id: "4.10.2", text: "Inventario actualizado por ambientes." } ],
            "5. Atención de emergencias": [ { id: "5.1", text: " Disponibilidad de Área o ambiente para atencion segura de emergencias(disponibilidad de equipamiento, material." },{ id: "5.1.1", text: " Equipamiento necesario.(camilla, gradilla, instrumental, Biombo, lámpara cuello de ganso, ambu adulto y pediátrico)." },{ id: "5.1.2", text: "Disponibilidad de fuente de agua." },{ id: "5.1.3", text: " Existencia de stock de medicamentos de emergencias con Kardex y en almacenamiento seguro." } ],
            "6. Estructuras de calidad": [ { id: "6.1", text: " Comité de Análisis de la Información -  técnico administrativo." },{ id: "6.2", text: "Gestión de la Calidad." },{ id: "6.3", text: "Auditoria Medica." },{ id: "6.4", text: " Comité de Bioseguridad y gestión de residuos solidos." },{ id: "6.5", text: "Lactancia Materna." },{ id: "6.6", text: "Farmacia y terapéutica." },{ id: "6.7", text: "Referencia y contrareferencia." } ]
        };
        const totalItems = Object.values(checklistData).flat().length;

        const generateForm = () => {
            let htmlContent = '';
            for (const sectionTitle in checklistData) {
                htmlContent += `<div class="form-section"><h3>${sectionTitle}</h3><table><thead><tr><th>N°</th><th>REQUISITOS</th><th>CUMPLE</th><th>OBSERVACIONES</th></tr></thead><tbody>`;
                checklistData[sectionTitle].forEach(item => {
                    htmlContent += `<tr><td>${item.id}</td><td>${item.text}</td><td><div class="radio-container"><input type="radio" id="item${item.id}_si" name="item${item.id}" value="si"><label for="item${item.id}_si">SI</label><input type="radio" id="item${item.id}_no" name="item${item.id}" value="no"><label for="item${item.id}_no">NO</label></div></td><td><textarea name="obs${item.id}"></textarea></td></tr>`;
                });
                htmlContent += `</tbody></table></div>`;
            }
            form.innerHTML = htmlContent;
            totalItemsElem.textContent = totalItems;
        };

        const calcularResultados = () => {
            const countSi = form.querySelectorAll('input[type="radio"][value="si"]:checked').length;
            const porcentaje = totalItems > 0 ? (countSi / totalItems * 100) : 0;
            
            totalSiElem.textContent = countSi;
            porcentajeSiElem.textContent = `${porcentaje.toFixed(2)}%`;
            progressBar.style.width = `${porcentaje}%`;
            progressBar.textContent = `${porcentaje.toFixed(1)}%`;

            if (porcentaje < 50) {
                progressBar.style.backgroundColor = 'var(--red-glow)'; progressBar.style.boxShadow = '0 0 10px var(--red-glow)'; porcentajeSiElem.style.color = 'var(--red-glow)';
            } else if (porcentaje < 85) {
                progressBar.style.backgroundColor = 'var(--yellow-glow)'; progressBar.style.boxShadow = '0 0 10px var(--yellow-glow)'; porcentajeSiElem.style.color = 'var(--yellow-glow)';
            } else {
                progressBar.style.backgroundColor = 'var(--primary-color)'; progressBar.style.boxShadow = 'var(--glow-shadow)'; porcentajeSiElem.style.color = 'var(--primary-color)';
            }
        };
        
        const collectCurrentData = () => {
            const data = {
                id: Date.now(),
                datosGenerales: {},
                participantes: {},
                checklist: [],
                resumen: {}
            };
            ['nombreEstablecimiento', 'nombreCoordinador', 'jefeResponsable', 'fechaSupervision'].forEach(id => data.datosGenerales[id] = document.getElementById(id).value);
            ['evaluadorNombre', 'evaluadorCargo', 'evaluadoNombre', 'evaluadoCargo'].forEach(id => data.participantes[id] = document.getElementById(id).value);

            Object.values(checklistData).flat().forEach(item => {
                const checkedRadio = form.querySelector(`input[name="item${item.id}"]:checked`);
                data.checklist.push({
                    id: item.id,
                    text: item.text,
                    respuesta: checkedRadio ? checkedRadio.value : null,
                    observacion: form.querySelector(`textarea[name="obs${item.id}"]`).value
                });
            });
            data.resumen = {
                totalSi: totalSiElem.textContent,
                porcentajeSi: porcentajeSiElem.textContent
            };
            return data;
        };

        const resetForm = () => {
            document.querySelectorAll('#mainFormContainer input[type="text"], #mainFormContainer input[type="date"]').forEach(input => input.value = '');
            form.reset();
            calcularResultados();
        };

        const displaySavedEvaluations = () => {
            const savedEvaluations = JSON.parse(localStorage.getItem('evaluacionesGuardadas')) || [];
            savedListContainer.innerHTML = savedEvaluations.length === 0 ? '<p>No hay evaluaciones guardadas.</p>' : '';
            
            savedEvaluations.forEach((evaluation, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'saved-item';
                itemDiv.innerHTML = `
                    <div class="saved-item-info">${evaluation.datosGenerales.nombreEstablecimiento || 'Sin Nombre'} - ${evaluation.datosGenerales.fechaSupervision || 'Sin fecha'}</div>
                    <div class="saved-item-actions">
                        <!-- MEJORA DEFINITIVA: Botón de descarga individual -->
                        <button class="action-button small-button download-btn-saved" data-index="${index}">Descargar</button>
                        <button class="action-button small-button load-btn" data-index="${index}">Cargar</button>
                        <button class="delete-btn small-button" data-index="${index}">Eliminar</button>
                    </div>`;
                savedListContainer.appendChild(itemDiv);
            });
        };
        
        // MEJORA DEFINITIVA: Reingeniería de la función de carga para ser 100% robusta.
        const loadEvaluationData = (index) => {
            const savedEvaluations = JSON.parse(localStorage.getItem('evaluacionesGuardadas')) || [];
            const dataToLoad = savedEvaluations[index];
            if (!dataToLoad) return;

            resetForm(); // Limpieza inicial garantizada.

            Object.keys(dataToLoad.datosGenerales).forEach(key => { if(document.getElementById(key)) document.getElementById(key).value = dataToLoad.datosGenerales[key]; });
            Object.keys(dataToLoad.participantes).forEach(key => { if(document.getElementById(key)) document.getElementById(key).value = dataToLoad.participantes[key]; });
            
            dataToLoad.checklist.forEach(item => {
                if (item.respuesta) {
                    const radio = form.querySelector(`input[name="item${item.id}"][value="${item.respuesta}"]`);
                    if (radio) radio.checked = true;
                }
                const textarea = form.querySelector(`textarea[name="obs${item.id}"]`);
                if (textarea) textarea.value = item.observacion;
            });

            // Forzar el recálculo y la actualización visual
            setTimeout(calcularResultados, 100); 

            savedEvaluationsSection.style.display = 'none';
            alert(`Evaluación de "${dataToLoad.datosGenerales.nombreEstablecimiento}" cargada en el formulario.`);
        };

        const deleteEvaluation = (index) => {
            let savedEvaluations = JSON.parse(localStorage.getItem('evaluacionesGuardadas')) || [];
            const evalToDelete = savedEvaluations[index];
            if (confirm(`¿Seguro que quieres eliminar la evaluación para "${evalToDelete.datosGenerales.nombreEstablecimiento}"? Esta acción no se puede deshacer.`)) {
                savedEvaluations.splice(index, 1);
                localStorage.setItem('evaluacionesGuardadas', JSON.stringify(savedEvaluations));
                displaySavedEvaluations();
            }
        };

        // MEJORA DEFINITIVA: Función para generar el contenido del DOC. Reutilizable.
        const generateDocContent = (data) => {
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Reporte</title></head><body>";
            const footer = "</body></html>";
            const styles = `<style>body{font-family:Arial,sans-serif;font-size:11pt}h1,h2,h3{color:#333}table{border-collapse:collapse;width:100%;margin-top:15px}th,td{border:1px solid #999;padding:6px;text-align:left}th{background-color:#f2f2f2}.section{margin-bottom:20px;page-break-inside:avoid}.signatures-doc{margin-top:60px;display:table;width:100%}.signature-box-doc{display:table-cell;width:50%;text-align:center}.signature-line{border-top:1px solid #000;margin-top:40px;padding-top:5px}</style>`;
            
            let content = `<h1>Reporte de Supervisión de Calidad</h1>
                <div class="section"><h2>Datos Generales</h2>
                    <p><strong>Establecimiento:</strong> ${data.datosGenerales.nombreEstablecimiento || 'No especificado'}</p>
                    <p><strong>Coordinador de Red:</strong> ${data.datosGenerales.nombreCoordinador || 'No especificado'}</p>
                    <p><strong>Jefe de Establecimiento:</strong> ${data.datosGenerales.jefeResponsable || 'No especificado'}</p>
                    <p><strong>Fecha:</strong> ${data.datosGenerales.fechaSupervision || 'No especificado'}</p>
                </div>
                <div class="section"><h2>Datos de los Participantes</h2>
                    <p><strong>Evaluador:</strong> ${data.participantes.evaluadorNombre || ''} (${data.participantes.evaluadorCargo || ''})</p>
                    <p><strong>Evaluado:</strong> ${data.participantes.evaluadoNombre || ''} (${data.participantes.evaluadoCargo || ''})</p>
                </div>`;

            for (const sectionTitle in checklistData) {
                content += `<div class="section"><h3>${sectionTitle}</h3><table><thead><tr><th>N°</th><th>Requisito</th><th>Resultado</th><th>Observaciones</th></tr></thead><tbody>`;
                const sectionItems = checklistData[sectionTitle].map(i => i.id);
                data.checklist.filter(item => sectionItems.includes(item.id)).forEach(item => {
                    const res = item.respuesta ? item.respuesta.toUpperCase() : 'No evaluado';
                    content += `<tr><td>${item.id}</td><td>${item.text}</td><td>${res}</td><td>${item.observacion || ''}</td></tr>`;
                });
                content += `</tbody></table></div>`;
            }

            content += `<div class="section"><h2>Resultados Finales</h2>
                <p><strong>Total Cumplidos:</strong> ${data.resumen.totalSi}</p>
                <p><strong>% Cumplimiento:</strong> ${data.resumen.porcentajeSi}</p>
            </div>
            <div class="signatures-doc">
                <div class="signature-box-doc"><div class="signature-line">Firma y Sello del Evaluador</div></div>
                <div class="signature-box-doc"><div class="signature-line">Firma y Sello del Evaluado</div></div>
            </div>`;
            
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(header + styles + content + footer);
            const a = document.createElement('a');
            a.href = source;
            a.download = `Reporte-${data.datosGenerales.nombreEstablecimiento || 'Supervision'}.doc`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        // --- EVENT LISTENERS ---
        form.addEventListener('change', calcularResultados);
        printBtn.addEventListener('click', () => window.print());

        newEvaluationBtn.addEventListener('click', () => {
            if (confirm('¿Estás seguro? Se limpiará el formulario actual. Los datos no guardados se perderán.')) {
                resetForm();
                savedEvaluationsSection.style.display = 'none';
            }
        });

        finishBtn.addEventListener('click', () => {
            const nombreEstablecimiento = document.getElementById('nombreEstablecimiento').value;
            if (!nombreEstablecimiento) {
                return alert('El "Nombre del Establecimiento" es obligatorio para guardar.');
            }
            const currentData = collectCurrentData();
            const savedEvaluations = JSON.parse(localStorage.getItem('evaluacionesGuardadas')) || [];
            savedEvaluations.push(currentData);
            localStorage.setItem('evaluacionesGuardadas', JSON.stringify(savedEvaluations));
            alert(`Evaluación para "${currentData.datosGenerales.nombreEstablecimiento}" guardada con éxito.`);
            resetForm();
        });

        viewSavedBtn.addEventListener('click', () => {
            displaySavedEvaluations();
            savedEvaluationsSection.style.display = 'block';
        });

        hideSavedBtn.addEventListener('click', () => { // MEJORA
            savedEvaluationsSection.style.display = 'none';
        });

        savedListContainer.addEventListener('click', (e) => {
            const index = e.target.dataset.index;
            if (index === undefined) return;

            if (e.target.classList.contains('load-btn')) {
                loadEvaluationData(index);
            }
            if (e.target.classList.contains('delete-btn')) {
                deleteEvaluation(index);
            }
            // MEJORA DEFINITIVA: Lógica para el botón de descarga individual
            if (e.target.classList.contains('download-btn-saved')) {
                const savedEvaluations = JSON.parse(localStorage.getItem('evaluacionesGuardadas')) || [];
                const dataToDownload = savedEvaluations[index];
                if (dataToDownload) {
                    generateDocContent(dataToDownload);
                }
            }
        });
        
        downloadBtn.addEventListener('click', () => {
            const currentData = collectCurrentData();
            if (!currentData.datosGenerales.nombreEstablecimiento) {
                return alert('Por favor, complete al menos el nombre del establecimiento antes de descargar.');
            }
            generateDocContent(currentData);
        });

        generateForm();
        calcularResultados();

    } catch (error) {
        console.error("Se ha producido un error crítico en la aplicación:", error);
        alert("Error: La aplicación no pudo cargarse correctamente. Por favor, revisa la consola del navegador para más detalles (presiona F12).");
    }
});
</script>

</body>
</html>